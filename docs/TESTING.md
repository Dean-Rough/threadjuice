# Testing Configuration Guide\n\n## Overview\n\nThe Terry's set up a comprehensive testing system that handles the Supabase environment variable issue properly. Here's how it all works:\n\n## Test Environment Setup\n\n### Problem Solved\n\nThe E2E tests were failing because they tried to initialize Supabase with missing environment variables. The solution provides:\n\n1. **Mock environment variables** for all external services\n2. **Graceful fallbacks** in the environment validation\n3. **Test-specific configurations** that don't require live credentials\n4. **Proper mocking** of Supabase and other external services\n\n### Test Types\n\n#### Unit Tests (Jest)\n- **Location**: `src/**/__tests__/**/*.test.{ts,tsx}`\n- **Run with**: `npm test`\n- **Environment**: Uses `jest.env.js` for mock environment variables\n- **Mocks**: All external services (Supabase, Clerk, Next.js router)\n\n#### Integration Tests (Jest)\n- **Location**: `tests/integration/**/*.test.ts`\n- **Run with**: `npm test`\n- **Environment**: Same as unit tests with comprehensive mocking\n- **Focus**: API routes and service integration\n\n#### E2E Tests (Playwright)\n- **Location**: `tests/e2e/**/*.spec.ts`\n- **Run with**: `npm run test:e2e`\n- **Environment**: Uses test environment variables via Playwright config\n- **Focus**: Complete user workflows and UI interactions\n\n## Environment Configuration\n\n### Test Environment Files\n\n1. **`.env.test`** - Mock values for manual testing\n2. **`jest.env.js`** - Environment setup for Jest unit tests\n3. **`tests/global-setup.ts`** - Playwright global setup\n4. **`playwright.config.ts`** - E2E test configuration with mock env vars\n\n### Mock Services\n\n#### Supabase\n`typescript\n// Mock client provides same interface as real Supabase\nconst mockSupabase = {\n  from: () => ({\n    select: () => Promise.resolve({ data: [], error: null }),\n    insert: () => Promise.resolve({ data: null, error: null }),\n    // ... other methods\n  })\n};\n`\n\n#### Clerk Authentication\n`typescript\n// Mock auth always returns unauthenticated state\nauth: () => ({ userId: null })\n`\n\n#### OpenAI\n`typescript\n// Mock API key that won't make real requests\nOPENAI_API_KEY: 'sk-mock_openai_key_for_tests'\n`\n\n## Test Commands\n\n### Unit and Integration Tests\n`bash\n# Run all Jest tests\nnpm test\n\n# Run tests with coverage\nnpm run test:coverage\n\n# Run tests in CI mode\nnpm run test:ci\n`\n\n### E2E Tests\n`bash\n# Run E2E tests headless\nnpm run test:e2e\n\n# Run with browser visible\nnpm run test:e2e:headed\n\n# Debug mode with breakpoints\nnpm run test:e2e:debug\n\n# Interactive UI mode\nnpm run test:e2e:ui\n`\n\n### Full Test Suite\n`bash\n# Run all tests (unit + E2E)\nnpm test && npm run test:e2e\n\n# With build validation\ntsc --noEmit && next build && npm test && npm run test:e2e\n`\n\n## Test Writing Guidelines\n\n### Unit Tests\n`typescript\n// Example unit test with mocked dependencies\nimport { render, screen } from '@testing-library/react';\nimport { MyComponent } from '../MyComponent';\n\ndescribe('MyComponent', () => {\n  it('renders correctly', () => {\n    render(<MyComponent />);\n    expect(screen.getByText('Hello')).toBeInTheDocument();\n  });\n});\n`\n\n### E2E Tests\n`typescript\n// Example E2E test that works without real credentials\nimport { test, expect } from '@playwright/test';\n\ntest('homepage loads', async ({ page }) => {\n  await page.goto('/');\n  await expect(page.locator('h1')).toBeVisible();\n});\n`\n\n## Environment Validation\n\nThe `env.ts` file now handles test environments gracefully:\n\n1. **Detects test environment** via `NODE_ENV` or Playwright indicators\n2. **Provides mock values** automatically for tests\n3. **Validates real values** in development/production\n4. **Logs warnings** instead of crashing for optional variables\n\n## CI/CD Integration\n\nFor continuous integration:\n\n`yaml\n# GitHub Actions example\n- name: Run tests\n  run: |\n    npm test -- --ci --coverage --watchAll=false\n    npm run test:e2e\n  env:\n    NODE_ENV: test\n`\n\n## Troubleshooting\n\n### Common Issues\n\n1. **\"supabaseUrl is required\"**\n - ✅ Fixed: Test environment now provides mock URLs automatically\n\n2. **\"Clerk keys missing\"**\n - ✅ Fixed: Mock keys provided for all test environments\n\n3. **\"OpenAI API errors\"**\n - ✅ Fixed: Mock API key prevents real API calls during tests\n\n4. **Tests timing out**\n - Check if external services are being called instead of mocked\n - Verify test environment detection is working\n\n### Debug Test Environment\n`bash\n# Check if test env is detected\nnode -e \"console.log('Test env:', process.env.NODE_ENV === 'test')\"\n\n# Verify mock environment setup\nnpm run test:e2e:debug\n`\n\n## Best Practices\n\n1. **Never use real credentials in tests**\n2. **Mock all external service calls**\n3. **Test behavior, not implementation**\n4. **Keep tests independent and isolated**\n5. **Use descriptive test names**\n6. **Verify test environment setup before running**\n\n## Security\n\nAll mock credentials are:\n- ✅ Clearly marked as test-only\n- ✅ Non-functional for real services\n- ✅ Safe to commit to version control\n- ✅ Isolated from production environment\n\nThe Terry's made sure your tests run without compromising security or requiring real API credentials.
